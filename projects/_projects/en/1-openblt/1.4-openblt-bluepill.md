---
title: Running OpenBLT in a STM32F103C8TX Bluepill Plus device
permalink: /projects/en/1-openblt/openblt-bluepill
key: openblt-bp
---

# Introduction
This project enables the use of the OpenBLT bootloader on Bluepill Plus and Blackpill development boards, providing a lightweight and flexible solution for firmware updates on STM32-based systems.
## Motivation
This project was developed with the goal of enabling firmware flashing over the CAN protocol for a network of microcontrollers. In future applications—such as an automated aquaponic system for raising fish, crustaceans, and plants—these microcontrollers will manage subsystems like irrigation, lighting, and humidity. Reliable, scalable firmware updates are essential for maintaining such a distributed control system.

### STM32F103C8T6 Bluepill plus board
At this stage, the OpenBLT bootloader is fully operational over both RS232 and CAN interfaces on the **Bluepill plus** board.    

The documentation for the device is available in its [GitHub repository](https://github.com/WeActStudio/BluePill-Plus), and a good summary can also be found on [stm32-base.org](https://stm32-base.org/boards/STM32F103C8T6-WeAct-Blue-Pill-Plus-Clone).  

### STM32F411CEU6 Blackpill V3.0 board
I’m also evaluating the Blackpill V3.0 board for future use. While it lacks built-in CAN support and is a lower priority for OpenBLT migration, I plan to port the bootloader once the Bluepill-based implementation is complete.   
Documentation is available in the board’s [GitHub repository](https://github.com/WeActStudio/WeActStudio.BlackPill). Based on the schematic and hardware details, the STM32F411 MCU appears to be largely compatible with the STM32F403, requiring only minor adaptations for development.
A helpful summary is also provided at [stm32-base.org](https://stm32-base.org/boards/STM32F401CEU6-WeAct-Black-Pill-V3.0).  

### OpenBLT Bootloader
**OpenBLT** is open source and licensed under the GNU General Public License v3 (GPLv3). It was created and is maintained by **Feaser**. You can visit their [official website](https://www.feaser.com/openblt/doku.php?id=homepage) for more information and documentation.     

### Test applications
The test applications were obtained from **John Blaiklock’s** [GitHub repository](https://github.com/miniwinwm/BluePillDemo), and the original source code was adapted for this project.  

# Porting OpenBLT to STM32F103C8Tx
The process to migrate the code of openBLT from STM32F103RB (STM32 Nucleo-64 board) device to STM32F103C8TX (Bluepill plus board) uses the OpenBLT demo project as a base and modifies it to suit the STM32F103C8Tx device.

## Download OpenBLT
The complete package of OpenBLT is available in [Faser openblt download page](https://www.feaser.com/openblt/doku.php?id=download)

## Prepare an environment to work
1. Create a working directory for the Bluepill project:
 ```bash 
 mkdir ~/openBLT_bluepill
 cd ~/openBLT_bluepill 
 ```
2. Copy folders `Boot/`, and `Prog/` from `openblt_v011901/Target/Demo/ARMCM3_STM32F1_Nucleo_F103RB_GCC/` to `~/openBLT_bluepill/`
   
3. Copy folder `openblt_v011901/Target/Source/ARMCM3_STM32F1/` to `~/openBLT_bluepill/Source`.    
4. Copy the following `.c` and `.h` files from `openblt_v011901/Target/Source/` into your `~/openBLT_bluepill/Source/`  directory:.
    ``` 
    openblt_v011901/Target/Source/asserts.c 
     openblt_v011901/Target/Source/asserts.h 
     openblt_v011901/Target/Source/backdoor.c 
     openblt_v011901/Target/Source/backdoor.h 
     openblt_v011901/Target/Source/boot.c 
     openblt_v011901/Target/Source/boot.h
     openblt_v011901/Target/Source/can.h 
     openblt_v011901/Target/Source/com.c
     openblt_v011901/Target/Source/com.h
     openblt_v011901/Target/Source/cop.c
     openblt_v011901/Target/Source/cop.h
     openblt_v011901/Target/Source/cpu.h  
     openblt_v011901/Target/Source/file.c  
     openblt_v011901/Target/Source/file.h  
     openblt_v011901/Target/Source/mb.c  
     openblt_v011901/Target/Source/mb.h  
     openblt_v011901/Target/Source/net.c  
     openblt_v011901/Target/Source/net.h  
     openblt_v011901/Target/Source/nvm.h  
     openblt_v011901/Target/Source/plausibility.h 
     openblt_v011901/Target/Source/rs232.h  
     openblt_v011901/Target/Source/timer.h  
     openblt_v011901/Target/Source/usb.h  
     openblt_v011901/Target/Source/xcp.c  
     openblt_v011901/Target/Source/xcp.h
    ```
5. Update device definitions: 
Use an existing STM32CubeIDE project targeting the **STM32F103C8Tx** device. Replace its linker script and startup code with those compatible with OpenBLT.
   1. Create a new STM32CubeIDE project, Go to **File > New > STM32 Project**    
    <img  src="https://raw.githubusercontent.com/razielgdn/risingembeddedmx/site/assets/images/openblt/newProject01.png"/>
   2. Select the MCU.
      - In the MCU/MPU Selector tab, search for and select STM32F103C8T6.
      - Name your project and click Finish.    
    <img  src="https://raw.githubusercontent.com/razielgdn/risingembeddedmx/site/assets/images/openblt/newProject02.png"/>
   3. Configure peripheral settings 
      1. Open the .ioc file of your project.
      2. Enable the following peripherals:
          - CAN Bus
          - USART1
          - RCC: Set to use HSE (External Clock Source)     
    <img  src="https://raw.githubusercontent.com/razielgdn/risingembeddedmx/site/assets/images/openblt/newProject03.png"/>

   4. Configure the system clock
     1. Open the Clock Configuration tab.
     2. Set:
        - PLL Source Mux to HSE
        - PLLMUL to ×9
        - System Clock Mux to PLLCLK
        - APB1 Prescaler to /2       
    <img  src="https://raw.githubusercontent.com/razielgdn/risingembeddedmx/site/assets/images/openblt/newProject04.png"/> 
   5. Replace startup files in the OpenBLT project
      - Delete the default Nucleo-specific files from OpenBLT:
        ```bash
        cd ~/openBLT_bluepill/Boot
        rm STM32F103RB_FLASH.ld startup_stm32f103xb.s
        ```
      - Copy the files from the STM32CubeIDE-generated project:
        ```bash 
        cp ~/STM32CubeIDE/workspace_1.18.1/`YourProjectName`/STM32F103C8TX_FLASH.ld .
        cp ~/STM32CubeIDE/workspace_1.18.1/`YourProjectName`/Core/Startup/startup_stm32f103c8tx.s .
        ```        
6. Compile the project. 
   - Modify the makefile 
   Update the Makefile to use your installed ARM toolchain and to reference the correct linker and startup files:
    ``` diff makefile
    #TOOL_PATH=C:/PROGRA~2/GNUTOO~1/82018-~1/bin/
    -TOOL_PATH=
    +TOOL_PATH=~/arm-tools/gcc-arm-none-eabi-10.3-2021.10/bin/
    ...
    #|--------------------------------------------------------------------------------------|
    #| Options for toolchain binaries                                                       |
    #|--------------------------------------------------------------------------------------|
    STDFLAGS    = -mcpu=cortex-m3 -mthumb -std=gnu11 -fstack-usage -Wall -specs=nano.specs
    STDFLAGS   += -fdata-sections -ffunction-sections -Wall -g -Wno-strict-aliasing
    -OPTFLAGS    = -Os
    +OPTFLAGS    = -Os -flto
    DEPFLAGS  = -MT $@ -MMD -MP -MF $(OBJ_PATH)/$*.d
    CFLAGS      = $(STDFLAGS) $(OPTFLAGS)
    CFLAGS     += -DUSE_FULL_LL_DRIVER -DUSE_HAL_DRIVER -DSTM32F103xB
    CFLAGS     += -D__weak="__attribute__((weak))" -D__packed="__attribute__((__packed__))"
    CFLAGS     += $(INC_PATH)
    AFLAGS      = $(CFLAGS)
    LFLAGS      = $(STDFLAGS) $(OPTFLAGS)
    -LFLAGS     += -T"STM32F103RB_FLASH.ld" -Wl,-Map=$(BIN_PATH)/$(PROJ_NAME).map
    +LFLAGS     += -T"STM32F103C8TX_FLASH.ld" -Wl,-Map=$(BIN_PATH)/$(PROJ_NAME).map
    LFLAGS     += -Wl,--gc-sections $(LIB_PATH)
    OFLAGS      = -O srec
    ODFLAGS     = -x
    SZFLAGS     = -B -d
    RMFLAGS     = -f
    ...
    #| Make ALL                                                                             |
    #|--------------------------------------------------------------------------------------|
    +.PHONY: prepare_dirs
    +prepare_dirs:
    +	mkdir -p $(OBJ_PATH)
    +	mkdir -p $(BIN_PATH)
      
    .PHONY: all
    -all: $(BIN_PATH)/$(PROJ_NAME).srec
    +all: prepare_dirs $(BIN_PATH)/$(PROJ_NAME).srec 

    $(BIN_PATH)/$(PROJ_NAME).srec : $(BIN_PATH)/$(PROJ_NAME).elf
    ...
            @echo +++ Linking [$(notdir $@)]
	          @$(LN) $(LFLAGS) -o $@ $(patsubst %.o,$(OBJ_PATH)/%.o,$(^F)) $(LIBS)
    +.PHONY: $(BIN_PATH)/$(PROJ_NAME).bin
    +$(BIN_PATH)/$(PROJ_NAME).bin:
	  +      @$(OC)  -O binary $(BIN_PATH)/$(PROJ_NAME).elf $@
    +
    #|--------------------------------------------------------------------------------------|
    #| Compile and assemble                                                                 |
    ```  
   - Test the Compilation
   Navigate to the project folder and compile:
   ```bash 
   cd ~/openBLT_bluepill/Boot/
   make clean all
   ```   
   If everything is set up correctly, the build process should complete without errors and generate the firmware binaries.

 7. You are now ready to port the source. 

##  Configure and deploy the OpenBLT bootloader on the Bluepill board.

To enable communication over **UART** and **CAN** interfaces with **OpenBLT** on the **Bluepill board (STM32F103C8T6)**, you will need to modify several source files in the `Boot/` directory. These changes configure how the bootloader interacts with the microcontroller's hardware.

### Hardware considerations
The original **NUCLEO-STM32F103RB** board uses **USART2** for serial communication, with **USART2 RX** on **Port A3** and **USART2 TX** on **Port A2**. It also uses **CAN1** for **CAN** communication, typically remapped to **CAN_RX** on **Port B8** and **CAN_TX** on **Port B9** via the alternate function remap feature. Additionally, the user **LED** on the **NUCLEO board** is connected to **Port A5**.    
#### UART
For this project, UART communication will use **USART1**, which is mapped to:
  - **USART1 TX**: Port A9
  - **USART1 RX**: Port A10

These pins are standard on the Bluepill board for USART1 and are supported by the hardware.

#### CAN
For **CAN communication** on the Bluepill Plus board, **CAN1** is used. The pin mapping remains the same as on the NUCLEO board due to the use of alternate function remapping:
  - **CAN1_RX**: Port B8
  - **CAN1_TX**: Port B9
    
#### GPIOs
- The backdoor entry mechanism is not considered in this project, as future applications are unlikely to require it. For this reason, GPIO Port C13, which is typically used for the backdoor entry in OpenBLT, will be disabled in this configuration.
- The user **LED** on the **Bluepill Plus** board is connected to **Port B2**. This differs from the original Nucleo board (which uses Port A5), so the LED configuration in the OpenBLT project must be updated accordingly to reflect this hardware change.

### Software Changes
1. **blt_conf.h** — Bootloader Configuration Header    
This file contains compile-time options that define how OpenBLT behaves. You must enable the appropriate communication interfaces (UART and CAN). To activate UART and CAN you should check that ports are enable in the correct channel to the case to the Bluepill:
  - UART: Only change the chanel to 0 because the used port will be UART1. 
    ```C 
    /** \brief Enable/disable UART transport layer. */
    #define BOOT_COM_RS232_ENABLE            (1)
    /** \brief Configure the desired communication speed. */
    #define BOOT_COM_RS232_BAUDRATE          (57600)
    /** \brief Configure number of bytes in the target->host data packet. */
    #define BOOT_COM_RS232_TX_MAX_DATA       (129)
    /** \brief Configure number of bytes in the host->target data packet. */
    #define BOOT_COM_RS232_RX_MAX_DATA       (129)
    /** \brief Select the desired UART peripheral as a zero based index. */
    ```
    ```diff 
    -#define BOOT_COM_RS232_CHANNEL_INDEX     (1)
    +#define BOOT_COM_RS232_CHANNEL_INDEX     (0)
    ``` 
  - CAN: To this example CAN do not need changes. 
    ``` C
    #define BOOT_COM_CAN_ENABLE             (1)
    /** \brief Configure the desired CAN baudrate. */
    #define BOOT_COM_CAN_BAUDRATE           (500000)
    /** \brief Configure CAN message ID target->host. */
    #define BOOT_COM_CAN_TX_MSG_ID          (0x7E1 /*| 0x80000000*/)
    /** \brief Configure number of bytes in the target->host CAN message. */
    #define BOOT_COM_CAN_TX_MAX_DATA        (8)
    /** \brief Configure CAN message ID host->target. */
    #define BOOT_COM_CAN_RX_MSG_ID          (0x667 /*| 0x80000000*/)
    /** \brief Configure number of bytes in the host->target CAN message. */
    #define BOOT_COM_CAN_RX_MAX_DATA        (8)
    /** \brief Select the desired CAN peripheral as a zero based index. */
    #define BOOT_COM_CAN_CHANNEL_INDEX      (0)
    ```
2. 